<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#2561D1" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png" />
  <title>Choix des cartes</title>
  <link rel="stylesheet" href="assets/tailwind.css">
  <link href="https://fonts.googleapis.com/css2?family=Braah+One&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Braah One', sans-serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
  </style>
</head>
<body class="bg-[#2561D1] text-white w-screen h-screen overflow-hidden flex flex-col">

  <!-- Header (fixe) -->
  <header class="flex items-center p-4 gap-3">
    <img src="assets/logo.png" alt="Secret Story Logo" class="w-[4.5rem]" />
    <div class="flex flex-col flex-1 gap-1">
      <h1 class="text-[1rem] text-black bg-white px-3 py-2 rounded-xl">Chaque joueur choisit une carte</h1>
      <div class="flex items-center gap-2 text-xs">
        <span id="playerCountLabel" class="bg-black/40 px-3 py-1 rounded">-- joueurs</span>
        <span id="progressLabel" class="bg-white/30 px-3 py-1 rounded">0/0 prises</span>
      </div>
    </div>
  </header>

  <main id="cardGrid"
        class="flex-1 overflow-y-auto no-scrollbar px-4 pb-32 grid grid-cols-2 gap-4 sm:gap-6 place-content-start">
  </main>

  <!-- Bouton démarrage (fixe) -->
  <div class="absolute bottom-4 inset-x-0 flex items-center justify-between px-4 gap-3">
    <button id="resetBtn" class="px-4 py-3 rounded-full bg-white/20 text-white text-sm border border-white/40">Réinitialiser</button>
    <button id="startGame" class="flex-1 h-14 rounded-full bg-white text-pink-500 shadow-lg flex items-center justify-center opacity-60 cursor-not-allowed">
      <span id="startLabel" class="text-lg font-bold">...</span>
    </button>
  </div>

  <!-- Modal nom joueur -->
  <div id="nameModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-30 px-4">
    <div class="bg-white text-black rounded-2xl w-full max-w-sm p-6 shadow-2xl">
      <h3 class="text-lg font-bold mb-2">Nom du joueur</h3>
      <p class="text-sm text-gray-600 mb-4">La carte sera marquée à son nom.</p>
      <input id="playerNameInput" type="text" class="w-full border rounded-xl px-3 py-2 mb-4 focus:outline-none focus:ring-2 focus:ring-pink-500" placeholder="Ex: Alex">
      <div class="flex gap-2">
        <button id="cancelModal" class="flex-1 px-4 py-2 rounded-xl border border-gray-300">Annuler</button>
        <button id="confirmModal" class="flex-1 px-4 py-2 rounded-xl bg-pink-500 text-white">Valider</button>
      </div>
    </div>
  </div>

  <!-- JS dynamique -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" integrity="sha512-2pKXCBfbNILIr05oig3NbS1Ry6j8Tz6kKI/hX3sI5Yucs5cjox96D65gis6pZeRAEIJ5zsxFrqxbPjzvY4xX2Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    const cardGrid = document.getElementById('cardGrid');
    const startGame = document.getElementById('startGame');
    const startLabel = document.getElementById('startLabel');
    const playerCountLabel = document.getElementById('playerCountLabel');
    const progressLabel = document.getElementById('progressLabel');
    const nameModal = document.getElementById('nameModal');
    const nameInput = document.getElementById('playerNameInput');
    const cancelModal = document.getElementById('cancelModal');
    const confirmModal = document.getElementById('confirmModal');
    const resetBtn = document.getElementById('resetBtn');
    const MIN_PLAYERS = 4;
    const MAX_PLAYERS = 20;
    const storedCount = Number(localStorage.getItem('playerCount')) || MIN_PLAYERS;
    const playerCount = Math.max(MIN_PLAYERS, Math.min(MAX_PLAYERS, storedCount));
    let selectedIndex = null;

    playerCountLabel.textContent = `${playerCount} joueurs`;

    const SECRET_POOL = [
      { title: "Je parle 6 langues", textHint: "J'ai trop de dictionnaires", audioHint: "Voix multilingue enchainee", imageHint: "Pile de livres multilingues" },
      { title: "J'ai saute en parachute 12 fois", textHint: "Je connais le vent mieux que ma chambre", audioHint: "Souffle d'air + bip d'altimetre", imageHint: "Silhouette en chute libre" },
      { title: "Je fais de la cuisine moleculaire", textHint: "L'azote liquide est mon meilleur ami", audioHint: "Crepitement/bulles douces", imageHint: "Assiette futuriste avec spheres" },
      { title: "J'ai un tatouage galaxie cache", textHint: "J'emporte la Voie lactee partout", audioHint: "Ambiance spatiale synthwave lente", imageHint: "Motif galaxie sur peau" },
      { title: "J'ai joue incognito dans un film", textHint: "On me voit 3 secondes si on fait pause", audioHint: "Clap + murmure de plateau", imageHint: "Plateau de tournage flou" },
      { title: "Je gagne les quiz musique 80s", textHint: "Je reconnais un tube en 2 secondes", audioHint: "Riff synthe 80s", imageHint: "Cassettes roses empilees" },
      { title: "Je resous les Rubik's cube en 40s", textHint: "Mes doigts ne tiennent pas en place", audioHint: "Cliquetis de cube rapide", imageHint: "Cube eclate en couleurs" },
      { title: "J'ai campe au pied d'un volcan", textHint: "Je dors bien meme avec un grondement", audioHint: "Grondement sourd + feu", imageHint: "Tente devant un volcan rougeoyant" },
      { title: "Je fabrique mes vetements", textHint: "Mes patrons envahissent mon salon", audioHint: "Bruit de machine a coudre", imageHint: "Bobines et tissus colores" },
      { title: "Je collectionne les instruments", textHint: "Mon salon est un mini studio", audioHint: "Accord de guitare + beat leger", imageHint: "Guitare, clavier et ukulele alignes" },
      { title: "Je suis apneiste amateur", textHint: "Je retiens mon souffle en lisant", audioHint: "Bulle d'eau et respiration calme", imageHint: "Silhouette sous-marine en apnee" },
      { title: "J'ai deja traverse un desert a velo", textHint: "Le sable est mon pire ennemi", audioHint: "Vent sec + cliquetis de chaine", imageHint: "Cycliste dans les dunes" }
    ];

    const loadAssignments = () => {
      const stored = JSON.parse(localStorage.getItem('secretAssignments') || '[]');
      if (stored.length === playerCount) return stored;
      const shuffled = [...SECRET_POOL].sort(() => Math.random() - 0.5);
      while (shuffled.length < playerCount) {
        shuffled.push(SECRET_POOL[shuffled.length % SECRET_POOL.length]);
      }
      const picked = shuffled.slice(0, playerCount);
      localStorage.setItem('secretAssignments', JSON.stringify(picked));
      return picked;
    };

    let secretAssignments = loadAssignments();
    let players = JSON.parse(localStorage.getItem('players') || '[]');

    const openModal = (index) => {
      selectedIndex = index;
      nameInput.value = players[index]?.name || "";
      nameModal.classList.remove('hidden');
      nameModal.classList.add('flex');
      nameInput.focus();
      gsap.fromTo(nameModal.querySelector('div'), { scale: 0.9, opacity: 0 }, { scale: 1, opacity: 1, duration: 0.2, ease: "power2.out" });
    };

    const closeModal = () => {
      nameModal.classList.add('hidden');
      nameModal.classList.remove('flex');
      selectedIndex = null;
    };

    const updateStartButton = () => {
      const assigned = players.filter(p => p && p.name && p.name.trim().length > 0).length;
      const missing = Math.max(0, playerCount - assigned);
      progressLabel.textContent = `${assigned}/${playerCount} prises`;
      if (missing === 0) {
        startGame.classList.remove('opacity-60', 'cursor-not-allowed');
        startLabel.textContent = 'GO';
        startGame.disabled = false;
      } else {
        startGame.classList.add('opacity-60', 'cursor-not-allowed');
        startLabel.textContent = missing === 1 ? '1 carte' : `${missing} cartes`;
        startGame.disabled = true;
      }
    };

    const renderCards = () => {
      cardGrid.innerHTML = "";
      for (let i = 0; i < playerCount; i++) {
        const card = document.createElement('div');
        card.className = [
          "card",
          "relative",
          "w-[42vw] max-w-[160px]",
          "h-[26vh] max-h-[220px]",
          "rounded-[12px] border-[3px] border-white",
          "shadow-[7px_5px_8px_rgba(0,0,0,0.25)]",
          "flex items-center justify-center",
          "bg-[radial-gradient(50%_50%_at_50%_50%,_#FF68B7_0%,_#FF049C_100%)]",
          "cursor-pointer",
          "transition-transform",
          "active:scale-95"
        ].join(" ");

        const logo = document.createElement('img');
        logo.src = "assets/logo.png";
        logo.alt = "Carte Secret Story";
        logo.className = "w-1/2";
        card.appendChild(logo);

        const label = document.createElement('span');
        label.className = "absolute bottom-2 left-2 text-[11px] bg-black/50 px-2 py-1 rounded";
        const playerName = players[i]?.name;
        label.textContent = playerName ? `Pris par ${playerName}` : `Carte ${i + 1}`;
        card.appendChild(label);

        card.addEventListener('click', () => {
          openModal(i);
        });

        cardGrid.appendChild(card);
      }
      gsap.from(".card", { opacity: 0, y: 20, duration: 0.4, stagger: 0.05, ease: "power2.out" });
    };

    confirmModal.addEventListener('click', () => {
      if (selectedIndex === null) return;
      const name = nameInput.value.trim();
      if (!name) return;
      players[selectedIndex] = { name };
      localStorage.setItem('players', JSON.stringify(players));
      localStorage.setItem('currentPlayerIndex', selectedIndex);
      localStorage.setItem('playerCount', playerCount);
      closeModal();
      renderCards();
      updateStartButton();
      window.location.href = "cartesecret.html";
    });

    cancelModal.addEventListener('click', closeModal);
    nameModal.addEventListener('click', (e) => {
      if (e.target === nameModal) closeModal();
    });

    resetBtn.addEventListener('click', () => {
      players = [];
      localStorage.removeItem('players');
      localStorage.removeItem('secretAssignments');
      localStorage.removeItem('currentPlayerIndex');
      secretAssignments = loadAssignments();
      renderCards();
      updateStartButton();
    });

    startGame.addEventListener('click', () => {
      if (startGame.disabled) return;
      window.location.href = "maingame.html";
    });

    renderCards();
    updateStartButton();
  </script>
  <script src="register-sw.js"></script>
</body>
</html>
